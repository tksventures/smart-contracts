<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Timelock Dapp Tool</title>
    <link crossorigin="anonymous" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css"
          integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" rel="stylesheet">
    <style>
        .pure-button {
            color: white;
            border-radius: 4px;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
            min-width: 100px;
        }

        .pure-label {
          margin: 2px;
        }

        .button-success,
        .button-error,
        .button-warning,
        .button-secondary {
            color: white;
            border-radius: 4px;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        }

        .button-success {
            background: rgb(28, 184, 65); /* this is a green */
        }

        .button-error {
            background: rgb(202, 60, 60); /* this is a maroon */
        }

        .button-warning {
            background: rgb(223, 117, 20); /* this is an orange */
        }

        .button-secondary {
            background: rgb(66, 184, 221); /* this is a light blue */
        }

    </style>
</head>
<body>
<div class="pure-g">

    <div class="pure-u-1-24"></div>

    <div class="pure-u-22-24">

        <div class="pure-u-5-5"></div>

        <div class="pure-u-5-5">

            <table class="pure-u-5-5 pure-table pure-table-horizontal">
                <thead>
                </thead>

                <tbody>
                <tr>
                    <td>
                        <div class="pure-control-group">
                            <form class="pure-form pure-form-aligned">
                                <input id="scriptAddress" placeholder="Script address" autocomplete="on" type="text">
                            </form>
                        </div>
                    </td>
                    <td>
                      <div class="pure-control-group">
                          <form class="pure-form pure-form-aligned">
                              <input id="asset" placeholder="Token Asset ID" autocomplete="on" type="text">
                          </form>
                      </div>
                  </td>
                    <td>
                        <form class="pure-form pure-form-aligned">
                            <input id="keeperAddress" placeholder="WavesKeeper address" readonly type="text">
                        </form>
                    </td>
                    <td>
                        <form class="pure-form pure-form-aligned">
                            <input id="hasWaves" placeholder="Waves balance" readonly type="text">
                        </form>
                    </td>
                    <td>
                        <button style="opacity: 1" disabled class="pure-button button-error" id="keeperStatus" type="button">Keeper status</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="pure-u-5-5"></div>

        <form class="pure-form pure-form-aligned">
            <fieldset>
                <div class="pure-control-group">
                    <input id="withdraw" placeholder="Token amount" type="text">
                    <button id="withdrawBtn" class="pure-button pure-button-primary" type="button" disabled>Withdraw</button>
                    <div class="pure-label" id="withdrawAmt">Total Released: </div>
                </div>

                <div class="pure-control-group">
                    <input id="deposit" placeholder="Token amount" type="text">
                    <button id="depositBtn" class="pure-button pure-button-primary" type="button" disabled>Deposit</button>
                    <div class="pure-label" id="depositAmt">Total Locked: </div>
                </div>
            </fieldset>
        </form>

        <form class="pure-form pure-form-aligned">
          <fieldset>
              <div class="pure-control-group">
                  <input id="totalChunks" placeholder="Total Chunks" type="text">
                  <input id="interval" placeholder="Block Interval" type="text">
                  <input id="initialDelay" placeholder="Initial Delay" type="text">
              </div>
              <div class="pure-label" id="chunkEstimate">Blocks until next chunk is released: ...</div>
              <div class="pure-label" id="timeEstimate">Estimated end date: ...</div>
              <button id="lockBtn" class="pure-button button-warning" type="button" disabled>!Initiate Lock!</button>
          </fieldset>
      </form>

    </div>
    <div class="pure-u-1-24"></div>
</div>

<script>

  var appData = {};

  function getValueFromKey(targetKey, data = appData.dAppData) {
    if (!data || !data.length) return null;
    const accountDataPoint = data.find(({ key, value }) => key === targetKey);
    return accountDataPoint ? accountDataPoint.value : null;
  }

  async function getScriptData() {
    const res = await fetch(`${appData.node}/addresses/data/${appData.dApp}`);
    const json = await res.json();
    appData.dAppData = json;
    updateScriptLabels();
  }

  async function getHeight() {
    const res = await fetch(`${appData.node}/blocks/height`);
    const json = await res.json();
    appData.height = json.height;
    updateHeightLabels();
  }

  function updateScriptLabels() {
    const lockedAmountLabel = document.querySelector('#depositAmt');
    lockedAmountLabel.innerHTML = `Total locked: ${getValueFromKey('lockedAmount') || getValueFromKey('storedAmount') || 0}`;
    const releasedAmountLabel = document.querySelector('#withdrawAmt');
    releasedAmountLabel.innerHTML = `Total released: ${getValueFromKey('amountClaimed') || 0}`;
  }

  function updateHeightLabels() {
    const blocksRemaining = appData.height - getValueFromKey('lockBlock');
    const endDateLabel = document.querySelector('#timeEstimate');
  }

  function setStatus(status, text) {
    var statusBtn = document.querySelector('#keeperStatus');
    statusBtn.innerHTML = text;
    statusBtn.className = 'pure-button button-' + status;
    appData.keeper = status;
  }

  function setAddress(data) {
    var address = data.account && data.account.address;
    var addressInp = document.querySelector('#keeperAddress');
    addressInp.value = address;
    appData.address = address;
  }

  function setBalance(data) {
    var balance = data.account && data.account.balance && data.account.balance.available;
    var balanceInp = document.querySelector('#hasWaves');
    var f, s;

    if (balance.length <= 8) {
        s = Number(balance) || 0;
        f = '0';
    } else {
        s = Number(balance.slice(-8));
        f = Number(balance.slice(0, -8));
    }

    balanceInp.value = f + '.' + s + ' Waves';

    appData.balance = { f: f, s: s };
  }

  function listenKeeper(data) {
    if (!data.initialized) {
      setStatus('warning', 'Create waves account');
      return null;
    }

    if (data.locked) {
      setStatus('warning', 'Unlock keeper');
      return null;
    }

    appData.node = data.network.server;

    setStatus('success', 'Keeper ready');
    setAddress(data);
    setBalance(data);
    checkDeposit();
    checkWithdraw();
  }

  function parseKeeperErrors(error) {
    let errorText = error.message || 'Error';
    setStatus('error', errorText);
  }

  function checkKeeper() {
    if (!window.WavesKeeper) {
        var errorText = 'Install WavesKeeper and restart page';
        setStatus('error', errorText);
        return null;
    }

    window.WavesKeeper.initialPromise.then(function () {
        window.WavesKeeper.on('update', listenKeeper);
        return window.WavesKeeper.publicState();
    }).then(
        listenKeeper,
        parseKeeperErrors
    )
  }

  function changeScriptAddress() {
    var addressInp = document.querySelector('#scriptAddress');
    var address = addressInp.value;
    appData.dApp = address.trim();
    getScriptData();
    getHeight();
    checkDeposit();
    checkWithdraw();
    checkLock();
  }

  function changeAssetId() {
    var addressInp = document.querySelector('#asset');
    var address = addressInp.value;
    appData.assetId = address.trim();
    checkDeposit();
    checkWithdraw();
    checkLock();
  }

  function checkDeposit() {
    if (!appData.dApp || appData.keeper !== 'success' || !appData.deposit) {
        document.querySelector('#depositBtn').disabled = true;
    } else {
        document.querySelector('#depositBtn').disabled = null;
    }
  }

  function checkWithdraw() {
    if (!appData.dApp || appData.keeper !== 'success' || !appData.withdraw) {
        document.querySelector('#withdrawBtn').disabled = true;
    } else {
        document.querySelector('#withdrawBtn').disabled = null;
    }
  }

  function checkLock() {
    if (!appData.dApp || appData.keeper !== 'success' || !(appData.totalChunks && appData.interval && appData.initialDelay)) {
        document.querySelector('#lockBtn').disabled = true;
    } else {
        document.querySelector('#lockBtn').disabled = null;
    }
  }

  function setDepositAmount() {
    var amount =  document.querySelector('#deposit').value;
    appData.deposit = amount;
    checkDeposit();
  }

  function setWithdrawAmount() {
    var amount =  document.querySelector('#withdraw').value;
    appData.withdraw = amount;
    checkWithdraw();
  }

  function setTotalChunks() {
    var amount =  document.querySelector('#totalChunks').value;
    appData.totalChunks = amount;
    checkLock();
  }

  function setBlockInterval() {
    var amount =  document.querySelector('#interval').value;
    appData.interval = amount;
    checkLock();
  }

  function setInitialDelay() {
    var amount =  document.querySelector('#initialDelay').value;
    appData.initialDelay = amount;
    checkLock();
  }

  document.querySelector('#asset').addEventListener('change', changeAssetId);
  document.querySelector('#asset').addEventListener('keyup', changeAssetId);

  document.querySelector('#scriptAddress').addEventListener('change', changeScriptAddress);
  document.querySelector('#scriptAddress').addEventListener('keyup', changeScriptAddress);

  document.querySelector('#totalChunks').addEventListener('change', setTotalChunks);
  document.querySelector('#totalChunks').addEventListener('keyup', setTotalChunks);

  document.querySelector('#interval').addEventListener('change', setBlockInterval);
  document.querySelector('#interval').addEventListener('keyup', setBlockInterval);

  document.querySelector('#initialDelay').addEventListener('change', setInitialDelay);
  document.querySelector('#initialDelay').addEventListener('keyup', setInitialDelay);

  document.querySelector('#deposit').addEventListener('change', setDepositAmount);
  document.querySelector('#deposit').addEventListener('keyup', setDepositAmount);

  document.querySelector('#withdraw').addEventListener('change', setWithdrawAmount);
  document.querySelector('#withdraw').addEventListener('keyup', setWithdrawAmount);

  window.onload = checkKeeper;
  setStatus('secondary', 'Wait keeper...');
</script>

<script>
  function lock() {
    var tx = {
        type: 16,
        data: {
            dApp: appData.dApp,
            call: {
                function: 'deposit',
                args: [
                  { type: 'integer', value: appData.totalChunks },
                  { type: 'integer', value: appData.interval },
                  { type: 'integer', value: appData.initialDelay }
                ]
            },
            payment: []
        }
    };

    WavesKeeper.signAndPublishTransaction(tx).then(
        resultOk,
        resultFail,
    );
  }

  document.querySelector('#lockBtn').addEventListener('click', lock);
</script>

<script>
  function withdraw() {
    var tx = {
        type: 16,
        data: {
            dApp: appData.dApp,
            call: {
                function: 'withdraw',
                args: [
                    {
                        "type": "integer",
                        "value": Number(appData.withdraw) * (10 ** 8)
                    }]
            },
            payment: []
        }
    };

    WavesKeeper.signAndPublishTransaction(tx).then(
        resultOk,
        resultFail,
    );
  }

  document.querySelector('#withdrawBtn').addEventListener('click', withdraw);
</script>

<script>
  function deposit() {
    var tx = {
        type: 16,
        fee: {
            "tokens": "0.05",
            "assetId": "WAVES"
        },
        data: {
            dApp: appData.dApp,
            call: {
                function: 'deposit',
                args: []
            },
            payment: [
                { tokens: appData.deposit, assetId: appData.assetId || null }
            ]
        }
    };

    WavesKeeper.signAndPublishTransaction(tx).then(
        resultOk,
        resultFail,
    );
  }

  document.querySelector('#depositBtn').addEventListener('click', deposit);
</script>

<script>
  function resultOk(data) {
    alert(JSON.stringify(data));
  }
  function resultFail(data) {
    alert(JSON.stringify(data));
  }
</script>

</body>
</html>